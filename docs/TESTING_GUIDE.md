# Testing Guide

## Testing with Local Files

The easiest way to test the OCR pipeline is with local files using the provided test scripts.

### Quick Start

**1. Create a test image:**
```bash
uv run python examples/create_test_image.py
```

This creates `test_document.png` with sample text.

**2. Process the image:**
```bash
uv run python examples/test_local_file.py test_document.png
```

**3. Check the output:**
```bash
cat output/test_document_ocr.md
```

### Testing Different File Types

#### Images

```bash
# PNG image
uv run python examples/test_local_file.py my_image.png

# JPEG image
uv run python examples/test_local_file.py photo.jpg

# TIFF document
uv run python examples/test_local_file.py scan.tiff
```

#### PDF Documents

```bash
# Single page PDF
uv run python examples/test_local_file.py document.pdf

# Multi-page PDF
uv run python examples/test_local_file.py report.pdf
```

### Advanced Options

**Use DeepSeek Engine (requires GPU):**
```bash
uv run python examples/test_local_file.py document.pdf --engine deepseek
```

**Custom output directory:**
```bash
uv run python examples/test_local_file.py image.png --output ./my_results
```

**Get help:**
```bash
uv run python examples/test_local_file.py --help
```

### Example Output

```
============================================================
üîç Simple OCR - Local File Test
============================================================

üìÑ File Information:
   Path: /path/to/test_document.png
   Size: 14,851 bytes (14.5 KB)
   MIME Type: image/png
   Engine: mock

üîß Initializing mock OCR engine...
üöÄ Starting OCR processing...

üìÇ Reading local file: /path/to/test_document.png
üìù Will save output to: output/test_document_ocr.md
‚úÖ Saved markdown to: output/test_document_ocr.md
üìä Size: 601 bytes

============================================================
üìä Processing Results
============================================================
Status: completed
Pages: 1
Processing Time: 101ms

üìù Markdown Preview (first 500 chars):
------------------------------------------------------------
# Mock OCR Result

This is a mock OCR result generated by MockOCREngine.
...
------------------------------------------------------------

‚úÖ Processing complete!
üìÅ Output directory: /path/to/output
```

## Testing the Complete Pipeline

### 1. Direct OCR Service Test

Test the OCR service directly without any infrastructure:

```python
import asyncio
from simple_ocr.adapters import OCREngineFactory, SimpleContentClient
from simple_ocr.services.ocr_service import OCRService
from simple_ocr.models.job import OCRJob

async def test_ocr():
    # Create engine and service
    engine = OCREngineFactory.create("mock", {})
    client = SimpleContentClient("http://localhost:8080")
    service = OCRService(engine, client)

    # Create job
    job = OCRJob(
        job_id="test-123",
        content_id="content-456",
        object_id="object-789",
        source_url="/path/to/image.png",
        mime_type="image/png"
    )

    # Process
    result = await service.process_job(job)
    print(f"Status: {result.status}")
    print(f"Pages: {result.page_count}")

    await service.cleanup()

asyncio.run(test_ocr())
```

### 2. HTTP API Test

Start the server and test via HTTP:

```bash
# Terminal 1: Start server
uv run uvicorn simple_ocr.main:app --reload

# Terminal 2: Test endpoints
curl http://localhost:8000/health
curl http://localhost:8000/api/v1/ocr/health
curl http://localhost:8000/api/v1/ocr/engines
```

**Submit a job:**
```bash
curl -X POST http://localhost:8000/api/v1/ocr/process \
  -H "Content-Type: application/json" \
  -d '{
    "job_id": "test-123",
    "content_id": "content-456",
    "object_id": "object-789",
    "source_url": "https://example.com/image.png",
    "mime_type": "image/png"
  }'
```

**View API docs:**
Open http://localhost:8000/docs in your browser

### 3. NATS Worker Test

**Prerequisites:**
- NATS server running
- simple-content API running (or mock)

**Start NATS with Docker:**
```bash
docker run -d --name nats -p 4222:4222 nats:latest
```

**Start worker:**
```bash
uv run python -m simple_ocr.workers.nats_worker
```

**Publish test job:**
```python
import asyncio
import json
from nats.aio.client import Client as NATS
from cloudevents.http import CloudEvent

async def publish_job():
    nc = await NATS().connect("nats://localhost:4222")
    js = nc.jetstream()

    # Create CloudEvent
    event = CloudEvent({
        "type": "com.simple-ocr.job.created",
        "source": "test-script",
    }, {
        "job_id": "test-123",
        "content_id": "content-456",
        "object_id": "object-789",
        "source_url": "/path/to/image.png",
        "mime_type": "image/png"
    })

    # Publish
    await js.publish("ocr.jobs", json.dumps(event.get_data()).encode())
    await nc.close()

asyncio.run(publish_job())
```

## Unit Tests

Run the test suite:

```bash
# All tests
uv run pytest tests/

# Unit tests only
uv run pytest tests/unit/

# Integration tests only
uv run pytest tests/integration/

# With coverage
uv run pytest tests/ --cov=simple_ocr --cov-report=html

# Specific test file
uv run pytest tests/unit/test_ocr_adapters.py -v

# Specific test
uv run pytest tests/unit/test_ocr_adapters.py::TestMockOCREngine::test_process_image_success -v
```

## Performance Testing

Test processing speed:

```python
import asyncio
import time
from pathlib import Path

async def benchmark_ocr():
    files = list(Path("test_files").glob("*.png"))

    start = time.time()
    for file in files:
        # Process file
        result = await process_local_file(str(file))

    duration = time.time() - start
    print(f"Processed {len(files)} files in {duration:.2f}s")
    print(f"Average: {duration/len(files):.2f}s per file")
```

## Troubleshooting

### Common Issues

**1. Import Errors**

```bash
# Make sure you're using uv run
uv run python examples/test_local_file.py image.png

# Or activate the virtual environment
source .venv/bin/activate
python examples/test_local_file.py image.png
```

**2. File Not Found**

```bash
# Use absolute path
uv run python examples/test_local_file.py /full/path/to/image.png

# Or relative from project root
uv run python examples/test_local_file.py ./test_data/image.png
```

**3. Mock vs DeepSeek Engine**

```bash
# Mock engine (no GPU needed, generates sample output)
uv run python examples/test_local_file.py image.png --engine mock

# DeepSeek engine (requires GPU and model)
uv run python examples/test_local_file.py image.png --engine deepseek
```

**4. Output Directory**

```bash
# Create output directory if it doesn't exist
mkdir -p output

# Or specify custom directory
uv run python examples/test_local_file.py image.png --output ./my_output
```

## Test Data

### Create Test Files

**Text image:**
```python
from PIL import Image, ImageDraw

img = Image.new('RGB', (800, 600), 'white')
draw = ImageDraw.Draw(img)
draw.text((50, 50), "Sample Text", fill='black')
img.save('test_text.png')
```

**Download sample PDFs:**
```bash
# Public domain document
wget https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf

# Or create your own
```

### Sample Test Suite

```bash
# Create test directory
mkdir -p test_files

# Copy test files
cp test_document.png test_files/
cp sample.pdf test_files/

# Batch process
for file in test_files/*; do
    uv run python examples/test_local_file.py "$file"
done
```

## Continuous Integration

Add to your CI pipeline:

```yaml
# .github/workflows/test.yml
name: Test
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        run: uv sync

      - name: Run tests
        run: uv run pytest tests/ -v --cov=simple_ocr

      - name: Test local file processing
        run: |
          uv run python examples/create_test_image.py
          uv run python examples/test_local_file.py test_document.png
```

## Next Steps

Once local testing works:

1. **Test with real simple-content API**
   - Deploy simple-content locally
   - Update CONTENT_API_URL
   - Test full integration

2. **Test with NATS**
   - Start NATS server
   - Start worker
   - Publish test jobs

3. **Test with GPU**
   - Set up DeepSeek model
   - Configure vLLM
   - Test with deepseek engine

4. **Load testing**
   - Process multiple files concurrently
   - Monitor memory usage
   - Optimize performance

## Resources

- **Examples**: `examples/` directory
- **Test Suite**: `tests/` directory
- **API Docs**: http://localhost:8000/docs (when server running)
- **Pipeline Docs**: `docs/PIPELINE.md`
- **Engine Docs**: `docs/OCR_ENGINES.md`
